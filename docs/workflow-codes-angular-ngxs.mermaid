flowchart TD
    A[ğŸ”„ Appå¯åŠ¨] --> B[AuthService.initializeAuth]
B --> C[AuthState.CheckAuthStatus]
C --> D{ğŸ” Tokenå­˜åœ¨ä¸”æœ‰æ•ˆ?}
D -->|âœ… æ˜¯| E[AuthState.SetAuthenticated]
D -->|âŒ å¦| F[AuthState.SetUnauthenticated]

E --> G[ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™]
F --> H[ğŸ“ é‡å®šå‘åˆ°ç™»å½•é¡µ]

%% ç™»å½•æµç¨‹
I[ğŸ” LoginComponent] --> J[dispatchLoginAction]
J --> K[AuthService.logincredentials]
K --> L{ğŸ”‘ ç™»å½•æˆåŠŸ?}
L -->|âœ… æ˜¯| M[dispatchLoginSuccess<br/>ğŸ’¾ å­˜å‚¨Token]
L -->|âŒ å¦| N[dispatchLoginFailed]

M --> O[ğŸš€ è·¯ç”±è·³è½¬åˆ°é¦–é¡µ]
N --> P[âš ï¸ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]

%% Tokenè‡ªåŠ¨åˆ·æ–°
Q[ğŸ”„ Tokenæ‹¦æˆªå™¨] --> R{â° æ£€æµ‹åˆ°Tokenå³å°†è¿‡æœŸ}
R -->|âœ… æ˜¯| S[dispatchRefreshToken]
S --> T[AuthService.refreshToken]
T --> U{ğŸ”„ åˆ·æ–°æˆåŠŸ?}
U -->|âœ… æ˜¯| V[dispatchRefreshTokenSuccess<br/>ğŸ”„ æ›´æ–°Token]
U -->|âŒ å¦| W[dispatchLogout]

%% æƒé™å®ˆå«
X[ğŸ§­ è·¯ç”±å¯¼èˆª] --> Y[AuthGuard.canActivate]
Y --> Z[store.dispatchCheckPermissions]
Z --> AA{ğŸ” AuthState.Selector<br/>hasRequiredPermissions?}
AA -->|âœ… æ˜¯| AB[âœ… å…è®¸è®¿é—®]
AA -->|âŒ å¦| AC[ğŸš« é‡å®šå‘åˆ°æ— æƒé™é¡µé¢]

%% ç™»å‡ºæµç¨‹
AD[ğŸ‘‹ ç”¨æˆ·ç‚¹å‡»ç™»å‡º] --> AE[dispatchLogout]
AE --> AF[AuthService.logout]
AF --> AG[ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„Token]
AG --> AH[ğŸ“ è·¯ç”±è·³è½¬åˆ°ç™»å½•é¡µ]

%% æ ·å¼å®šä¹‰ - ä½¿ç”¨æ·±è‰²èƒŒæ™¯å‹å¥½çš„é¢œè‰²
classDef default fill:#2d3748,stroke:#4a5568,stroke-width:2px,color:#ffffff
classDef success fill:#22543d,stroke:#38a169,stroke-width:2px,color:#ffffff
classDef warning fill:#744210,stroke:#d69e2e,stroke-width:2px,color:#ffffff
classDef error fill:#742a2a,stroke:#e53e3e,stroke-width:2px,color:#ffffff
classDef process fill:#2c5282,stroke:#3182ce,stroke-width:2px,color:#ffffff
classDef service fill:#553c9a,stroke:#805ad5,stroke-width:2px,color:#ffffff
classDef component fill:#234e52,stroke:#38b2ac,stroke-width:2px,color:#ffffff

class C,D,E,F,Y,Z,AA state
class B,K,T,AF service
class I,X,AD component
class G,O,AB,AH success
class H,N,P,W,AC error
class A,Q,R process